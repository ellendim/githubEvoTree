---
title: "Conserved I-graph"
author: "Ellen Dimmen Chapple"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
    theme: lumen
editor_options:
  chunk_output_type: console
---


```{r}

library(tidyverse)
library(igraph)
library(ggpattern)
library(RColorBrewer)

```


# Finding cliques based on weight of edges

```{r}
# Read in expressologs

expressologs <- read.delim("Data/DATA/textFiles/all_expressed_genes.txt", sep = " ") %>%  #
  filter(MaxpVal < 0.8)


expressologs_2 <- read.delim("Data/DATA/textFiles/all_expressed_genes.txt", sep = " ") %>% 
  filter(MaxpVal < 0.1)

cat("Orthogroups with at least one expressed pair:", expressologs %>% distinct(OrthologGroup) %>% nrow(), "\n")
cat("Orthogroups with at least one co-expressolog:", expressologs_2 %>% distinct(OrthologGroup) %>% nrow(), "\n")




```



```{r}

# Need the ones_and_zeros_all-file to use as a template for finding the ortholog groups specific for angiosperms - see
load("Data/DATA/ones_and_zeros_all.RData")

df_with_sums <- ones_and_zeros_all %>%
  mutate(Angiosperms = rowSums(. [1:3])) %>%
  mutate(Cross = rowSums(. [4:12]))%>%
  mutate(Gymnosperms = rowSums(. [13:15])) %>%
  mutate(Conserved = rowSums(. [1:15]))


conserved_ogs <- df_with_sums %>%
  filter(Conserved == 15) 
 

cat("Number of ortholog groups that have at least one expressed (not p-value cutoff) gene pair for all 15 pairs: ", nrow(conserved_ogs))


conserved_ogs <- conserved_ogs%>% 
  filter(rownames(conserved_ogs) %in% expressologs$OrthologGroup)


cons_ogs <- rownames(conserved_ogs)


length(cons_ogs)

```


```{r}
# Go through the list of ortholog groups that have at least one clique that includes all six species and find the largest weighted cliques and filter again for cliques that have at least 6 species. Compare the number of orthologs.
# palette_1 <- c("#3D5A71","#FFB000","#785EF0", "#DC267F","#FE6100")

largest_weighted_cliques_orthologGroups <- c()
expressologs_from_weighted_cliques <- c()
uuc_genes <-  c()

for (g in cons_ogs) {
  
      # g <- "OG0001067"
  
  expressologs_g <- expressologs %>% 
    filter(OrthologGroup == g) 
  
  expressologs_g <- expressologs_g %>% 
    mutate(UGeneSpecies1 = paste0(expressologs_g$Species1, "-", expressologs_g$GeneSpecies1),
           UGeneSpecies2 = paste0(expressologs_g$Species2, "-", expressologs_g$GeneSpecies2))
  
  nodes <- data.frame(name = unique(c(expressologs_g$UGeneSpecies1, expressologs_g$UGeneSpecies2)))
  
  edges <- data.frame(from = expressologs_g$UGeneSpecies1, 
                      to = expressologs_g$UGeneSpecies2, weight = -log(expressologs_g$MaxpVal))
  
  
  net <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
  # 
  # plot(net)
  # plot(net, layout =layout_randomly,  vertex.size= 10, vertex.color="#DC267F", edge.width = 1, edge.color = "#0E2841", margin = 0.1, vertex.label = "", vertex.label.family = "sans", vertex.label.font = 1, vertex.label.dist= 3)
  
  weighted_clique <- largest_weighted_cliques(net)[[1]]
  weighted_clique <- attr(weighted_clique, "names")
  
  
  
  clique_species <- unique(sapply(str_split(weighted_clique, "-"), function(x) { x[1]}))
  clique_genes <-  str_split_fixed(weighted_clique, "-", n = 2)[,2]
 
  # # --------------- Code for creating network with only the clique-members.------------
  
  # clique_genes_df <- expressologs_g %>%
  #   filter(UGeneSpecies1 %in% weighted_clique & UGeneSpecies2 %in% weighted_clique)
  # 
  # clique_edges <- data.frame(from = clique_genes_df$UGeneSpecies1,
  #                            to = clique_genes_df$UGeneSpecies2)
  # 
  # clique_nodes <- data.frame(name = unique(c(clique_genes_df$UGeneSpecies1, clique_genes_df$UGeneSpecies2)))
  # 
  # clique_net <- graph_from_data_frame(clique_edges, directed = FALSE, vertices = clique_nodes)
  # 
  # 
  #  plot(clique_net, layout =  layout_in_circle, vertex.size= 30,
  #    vertex.color="#DC267F", vertex.frame.width = 2.5, edge.width = 2, edge.color = "#0E2841", margin = 0.1, vertex.label.cex =0.8, vertex.label = "", vertex.label.family = "sans", vertex.label.font = 2, vertex.label.dist= 2)

   # If vertex labels are wanted: vertex.label.cex =0.8, vertex.label.family = "sans", vertex.label.font = 2,vertex.label.dist= 3, if not:  vertex.label =NA 


  
  
  
  if(length(clique_species) == 6) {
    

    largest_weighted_cliques_orthologGroups <- c(largest_weighted_cliques_orthologGroups, g)
 
    expressologs_in_clique <- expressologs_g %>%
      filter(UGeneSpecies1 %in% weighted_clique & UGeneSpecies2 %in% weighted_clique)
    
    
    
    expressologs_from_weighted_cliques <- rbind(expressologs_from_weighted_cliques, expressologs_in_clique)
    
      uuc_genes <- rbind(uuc_genes, data.frame(
      Orthogroup = rep(g, length(clique_genes)),
      Genes = clique_genes,
      Species = clique_species
      
      ))
    
      
      }}




cat("Number of ortholog groups with cliques: ",length(unique(largest_weighted_cliques_orthologGroups)))


```




# Creating data frame for group-wise counting


```{r}

# # Set p-value threshold
p_thr <- 0.1

weighted_clique_group_sum <- expressologs_from_weighted_cliques %>% 
  mutate(species_pair = paste0(Species1, Species2))



speciesPairs <- tibble(SpeciesPair = weighted_clique_group_sum %>% distinct(species_pair) %>% pull(species_pair),
                       SpeciesPairClade = c("Cross", "Gymno", "Gymno", "Cross", "Cross", "Cross", "Cross", "Angio",
                       "Angio", "Gymno", "Cross", "Cross", "Cross", "Cross", "Angio"))


weighted_clique_group_sum <-  left_join(weighted_clique_group_sum , speciesPairs, by = join_by("species_pair" == "SpeciesPair" ))

weighted_clique_group_sum <- weighted_clique_group_sum %>%
  group_by(OrthologGroup, species_pair) %>% 
  arrange(MaxpVal) %>%
  filter(MaxpVal < p_thr) %>% 
  group_by(OrthologGroup) %>% 
  mutate(conservedOG = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = SpeciesPairClade, values_from = SpeciesPairClade) 
  
weighted_clique_group_sum$Angio[is.na(weighted_clique_group_sum$Angio)] <- 0
weighted_clique_group_sum$Angio[weighted_clique_group_sum$Angio != 0] <-1
weighted_clique_group_sum$Gymno[is.na(weighted_clique_group_sum$Gymno)] <-0
weighted_clique_group_sum$Gymno[weighted_clique_group_sum$Gymno != 0] <-1
weighted_clique_group_sum$Cross[is.na(weighted_clique_group_sum$Cross)] <-0
weighted_clique_group_sum$Cross[weighted_clique_group_sum$Cross != 0] <-1



```


## Plotting the number of ultra-conserved and partially conserved ortholog groups

From the data frame above, we can filter out how many ortholog groups have partial conservation based on cliques. 

For ultra-conserved ortholog groups we require all pairs to have a significant expressolog in the clique, while the partial_3 ortholog groups must have at least 2/3 significant expressologs within the clades and 2/9 significant expressologs amongst the crossed pairs. 

**Ultra-conserved - scores:**

clades == 3
cross == 9

OR

conservedOG == 15

**Partial 3 conserved - scores:**

clades >= 2
cross >= 2



```{r}


ultra_conserved <- weighted_clique_group_sum %>% 
  filter(conservedOG == 15) 

length(unique(ultra_conserved$OrthologGroup))

# Saving the uuc-genes
uuc_genes_filtered <- uuc_genes %>% 
  filter(Orthogroup %in% ultra_conserved$OrthologGroup) %>% 
  group_by(Species) %>% 
  distinct(Genes, .keep_all = T) %>% 
  ungroup() %>% 
  group_by(Orthogroup) %>% 
  mutate(sum = n()) %>% 
  filter(sum == 6)

length(unique(uuc_genes_filtered$Orthogroup))

save(uuc_genes_filtered, file = "Data/DATA/uuc_orthologs.RData")


partial3_conserved <- weighted_clique_group_sum %>% 
  mutate_at(c("Angio", "Gymno", "Cross"), as.numeric) %>% 
  group_by(OrthologGroup) %>% 
  filter(sum(Angio) >=2 & sum(Gymno) >=2 & sum(Cross) >= 2)

length(unique(partial3_conserved$OrthologGroup))

```





```{r}
#Saving uuc-genes for only Aspen

uuc_genes_asp <- uuc_genes_filtered %>% 
  filter(grepl("Potra", Genes))

save(uuc_genes_asp, file ="Data/DATA/uuc_orthologs_asp.RData") # Now go to GSEA!

```



