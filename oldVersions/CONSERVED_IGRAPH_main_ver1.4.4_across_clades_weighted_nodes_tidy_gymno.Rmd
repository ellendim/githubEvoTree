---
title: "Conserved I-graph"
author: "Ellen Dimmen Chapple"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
    theme: lumen
editor_options:
  chunk_output_type: console
---


```{r}

library(tidyverse)
library(igraph)
library(ggpattern)
library(RColorBrewer)
library(ggplot2)

```


# Identifying complete and partial cliques amongst gymnosperm pairs

## Loading necessary files

The file "all_expressed_genes" are all (co-)expressologs between all pairs of species. The initial pre-filtering reduces memory requirements as there are a high number of expressologs with FDR = 1 (before rerun of ComPlEx scripts with fixed bug). 


```{r}
# 1) Load expressologs (filtering reduces memory requirements significantly)
expressologs <- read.delim("Data/DATA/textFiles/all_expressed_genes.txt", sep = " ") %>%  
  filter(MaxpVal < 0.9) 


# 2) Load template for identifying orthogroups that have (co-)expressologs and add rows for summarising. Remove orthogroups that have no (co-)expressologs and further filter for clade-specific orthogroups.

load("Data/DATA/ones_and_zeros_all.RData")
df_with_sums <- ones_and_zeros_all %>%
  mutate(Angiosperms = rowSums(. [1:3])) %>%
  mutate(Cross = rowSums(. [4:12]))%>%
  mutate(Gymnosperms = rowSums(. [13:15])) %>%
  mutate(Conserved = rowSums(. [1:15]))%>%
  filter(Conserved > 0) %>% 
  # filter(Angiosperms == 3 & Gymnosperms == 0 & Cross == 0)
  filter(Angiosperms == 0 & Gymnosperms == 3 & Cross == 0)


# 3) Refilter the conserved orthogroups to adjust for the initial p-value filtering and vectorise.
conserved_ogs <- df_with_sums%>% 
  filter(rownames(df_with_sums) %in% expressologs$OrthologGroup)


cons_ogs <-rownames(conserved_ogs)
cat("Number of ortholog groups that have at least one (co-)expressolog after initial filtering: ", nrow(conserved_ogs))


```

## Identifying orthogroups with complete cliques (can be skipped)

This step identifies which orthogroups have complete cliques and the number of cliques per orthogroup. This step can be skipped after output file is saved.
Furthermore, this step is not strictly necessary for clique identification but is useful to estimate runtime of code and if adjustments are required.

```{r}
# 1) Loop over all relevant (have at least 1 (co-)expressolog) orthogroups and count the nuber of max cliques that contain at least 6 members.

numb_of_cliques_per_og <- c()

for (g in cons_ogs) {
  # print(g)
    # g <- "OG0000001"
  
  expressologs_g <- expressologs %>% 
    filter(OrthologGroup == g) 
  
  expressologs_g <- expressologs_g %>% 
    mutate(UGeneSpecies1 = paste0(expressologs_g$Species1, "-", expressologs_g$GeneSpecies1),
           UGeneSpecies2 = paste0(expressologs_g$Species2, "-", expressologs_g$GeneSpecies2))
  
  nodes <- data.frame(name = unique(c(expressologs_g$UGeneSpecies1, expressologs_g$UGeneSpecies2)))
  
  edges <- data.frame(from = expressologs_g$UGeneSpecies1, 
                      to = expressologs_g$UGeneSpecies2)
  
  
  net <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
  
  # largest_clique <- largest_weighted_cliques(net)
  largest_clique <- max_cliques(net, min = 3, max = 3)

  
  
  numb_of_cliques_per_og <- rbind(numb_of_cliques_per_og, data.frame(Orthogroup = g,
                                                                     numbCliques = length(largest_clique)))
  
}

# 2) Remove orthogroups with no 6-member cliques.
numb_of_cliques_per_og <- numb_of_cliques_per_og %>% 
  arrange(desc(numbCliques)) %>% 
  filter(numbCliques > 0) 

paste0("Number of orthologs with at least one 6-membered clique: ", length(unique(numb_of_cliques_per_og$Orthogroup)))

# 3) Vectorise and save! 
cons_og_red <- numb_of_cliques_per_og$Orthogroup
save(cons_og_red, file = "Data/Data/conserved_orthogroups_gymnos_reduced.RData")
  
plot(density(log10(numb_of_cliques_per_og$numbCliques)),xlab = "Number of cliques per OG (log10)",main = "Distribution of cliques")

```

## Clique identification (3 members)

Cliques are identified in a similar loop as in previous chunk.
N.B! If all orthogroups are used (not only orthogroups with complete cliques) then the first if-statement needs to used.

Outside of loop:
- initiate list
- set min and max clique number

Outer loop iterates over all orthogroups:
- creates a network of all (co-)expressologs in the orthogroup, linking (co-)expressologs
- identifies all cliques that include all 3 species
- for the larger orthogroups, only a subset of cliques are saved (input value) - reduces runtime, but needs to include all orthogroups with complete cliques



Inner loop iterates over all (or subset) of cliques:
- saves names of genes and species within clique 
- filters the orthogroup to only contain genes within a clique
- adds an ID-tag to each clique 
- append the clique-containing orthogroup subset to a list

The list is unpacked into a data frame before the max p-values (FDR) are -log transformed, and the sum of each clique is calculated.

```{r}

# 

# load("Data/DATA/conserved_orthogroups_angios_reduced.RData")
expressologs_from_max_cliques <- list()
max_numb_of_cliques <- 5500 # Not really necessary for angiosperm-specific orthogroups


for (g in cons_og_red) {
  print(g)
  
   # g <- "OG0000585"
  
  expressologs_g <- expressologs %>% 
    filter(OrthologGroup == g) 
  
  expressologs_g <- expressologs_g %>% 
    mutate(UGeneSpecies1 = paste0(expressologs_g$Species1, "-", expressologs_g$GeneSpecies1),
           UGeneSpecies2 = paste0(expressologs_g$Species2, "-", expressologs_g$GeneSpecies2))
  
  nodes <- data.frame(name = unique(c(expressologs_g$UGeneSpecies1, expressologs_g$UGeneSpecies2)))
  
  edges <- data.frame(from = expressologs_g$UGeneSpecies1, 
                      to = expressologs_g$UGeneSpecies2)
 
  
  net <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
  

  largest_clique <- max_cliques(net, min = 3, max = 3)
  
  # if(length(largest_clique) == 0){
  #   break
  # }

  if(length(largest_clique) > max_numb_of_cliques){
      largest_clique_red <- largest_clique[1:max_numb_of_cliques]
    }else{largest_clique_red <- largest_clique}
    
    
  for(c in 1:length(largest_clique_red)){
    # c <- 1
          if (c %% 500 == 0) {
        cat(c, "\n")
      }

# c <- 1
    clique <- largest_clique[[c]]
    clique_name <- attr(clique, "names")

    clique_species <- str_split_fixed(clique_name, "-", n = 2)[,1]
    clique_genes <-  str_split_fixed(clique_name, "-", n = 2)[,2]
   
      expressologs_in_clique <- expressologs_g %>%
        filter(UGeneSpecies1 %in% clique_name & UGeneSpecies2 %in% clique_name) %>%
        select(c(1:5, 8)) %>% 
        mutate(cliqueID = paste0(g,"_" ,c))
        
        

      expressologs_from_max_cliques <- append(expressologs_from_max_cliques, list(expressologs_in_clique))

  }

}

clique_genes_unlisted <- plyr::ldply(expressologs_from_max_cliques)

clique_genes_unlisted_prefilter <- clique_genes_unlisted %>% 
  group_by(cliqueID) %>% 
  mutate(MaxpValNegLog = -log(MaxpVal)) %>% 
  mutate(NegLogCliqueSum = sum(MaxpValNegLog)) %>% 
  ungroup()

length(unique(clique_genes_unlisted_prefilter$OrthologGroup))
length(unique(clique_genes_unlisted_prefilter$cliqueID))
  
# save(clique_genes_unlisted_prefilter, file = "Data/DATA/clique_genes_gymnosperms_prefiltered.RData")


```


## Identifing complete and partial cliques ...



```{r}

load("Data/DATA/clique_genes_angiosperms_prefiltered.RData") # Cliques

```

Complete and partial cliques can be identified based on either the FDR-corrected p-values of the (co-)expressologs or based on clique sum.


```{r}

# ------------------ Filtering with p-value -----------------------

p_thr <- 0.1 # Co-expressolog is an expressolog with significant neighbourhood overlap at FDR < 0.1

weighted_max_cliques_filtered <- clique_genes_unlisted_prefilter %>%
  filter(MaxpVal < p_thr) %>% 
  group_by(cliqueID) %>% 
  mutate(cliqueSize = n()) %>% 
  ungroup()

weighted_max_cliques_filtered <- weighted_max_cliques_filtered %>% 
    mutate(UGeneSpecies1 = paste0(weighted_max_cliques_filtered$Species1, "-", weighted_max_cliques_filtered$GeneSpecies1),
           UGeneSpecies2 = paste0(weighted_max_cliques_filtered$Species2, "-", weighted_max_cliques_filtered$GeneSpecies2))


```


OR

```{r}

# ------------------ Filtering with clique sum -----------------------


cliqueSum <-  34.53878 # If all (co-)expressologs have a MaxPval of max 0.1, then the minimum sum of a complete clique is: (-log(0.1))*15 = 34.53878. 


weighted_max_cliques_filtered <- clique_genes_unlisted_prefilter %>%
  filter(NegLogCliqueSum >= cliqueSum) %>% 
  group_by(cliqueID) %>% 
  mutate(cliqueSize = n()) %>% 
  ungroup() 


weighted_max_cliques_filtered <- weighted_max_cliques_filtered %>% 
    mutate(UGeneSpecies1 = paste0(weighted_max_cliques_filtered$Species1, "-", weighted_max_cliques_filtered$GeneSpecies1),
           UGeneSpecies2 = paste0(weighted_max_cliques_filtered$Species2, "-", weighted_max_cliques_filtered$GeneSpecies2))


```



```{r}

# Complete cliques 

complete_cliques_gymno <- weighted_max_cliques_filtered %>% 
  filter(cliqueSize == 3) 

length(unique(complete_cliques_gymno$OrthologGroup))


# Partial cliques across all pairs (can be modified)

 partial_cliques_gymno <- weighted_max_cliques_filtered %>% 
   filter(cliqueSize >= 2)
length(unique(partial_cliques_gymno$OrthologGroup))


```

## Saving clique-genes

```{r}

# Complete cliques
species_1 <- complete_cliques_gymno%>% 
  select(c(1,7,11))%>% 
  rename(Species = "UGeneSpecies1")

species_2 <- complete_cliques_gymno %>% 
  select(c(1,7,12)) %>% 
  rename(Species = "UGeneSpecies2")


complete_cliques_gymno_listed <- rbind(species_1, species_2)

complete_cliques_gymno_listed <- complete_cliques_gymno_listed %>% 
  as.data.frame() %>% 
  group_by(cliqueID) %>% 
  distinct(Species, .keep_all = T) %>% 
  ungroup() %>% 
  distinct(Species, .keep_all = T) %>%
  group_by(cliqueID) %>% 
  mutate(cliqueSize = n()) %>% 
  filter(cliqueSize == 3)


length(unique(complete_cliques_gymno_listed$OrthologGroup))

# Partial cliques

species_1 <- partial_cliques_gymno%>% 
  select(c(1,7,11))%>% 
  rename(Species = "UGeneSpecies1")

species_2 <- partial_cliques_gymno %>% 
  select(c(1,7,12)) %>% 
  rename(Species = "UGeneSpecies2")


partial_cliques_gymno_listed <- rbind(species_1, species_2)

partial_cliques_gymno_listed <- partial_cliques_gymno_listed %>% 
  as.data.frame() %>% 
  group_by(cliqueID) %>% 
  distinct(Species, .keep_all = T) %>% 
  ungroup() %>% 
  distinct(Species, .keep_all = T) %>%
  group_by(cliqueID) %>% 
  mutate(cliqueSize = n()) %>% 
  filter(cliqueSize == 3)


length(unique(partial_cliques_gymno_listed$OrthologGroup))


# Save

save(complete_cliques_gymno_listed, file = "Data/DATA/complete_cliques_gymnos.RData")
save(partial_cliques_gymno_listed, file = "Data/DATA/partial_cliques_gymnos.RData")

```
















