---
title: "Conserved I-graph"
author: "Ellen Dimmen Chapple"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
    theme: lumen
editor_options:
  chunk_output_type: console
---


```{r}

library(tidyverse)
library(igraph)
library(ggpattern)
library(RColorBrewer)
library(ggplot2)

```


# Clique identification

## Loading necessary files

The file "all_expressed_genes" are all (co-)expressologs between all pairs of species, while "ones_and_zeros_all" is an overview over which orthogroups the various species pairs have at least one (co-)expressolog within. 


```{r}
# 1) Load expressologs (filtering reduces memory requirements significantly)
expressologs <- read.delim("Data/DATA/textFiles/all_expressed_genes.txt", sep = " ") %>%  
  filter(MaxpVal < 0.9) 

cat("Orthogroups with at least one expressed pair:", length(unique(expressologs$OrthologGroup)))

# 2) Load template for identifying orthogroups that have (co-)expressologs and add rows for summarising. Remove orthogroups that have no (co-)expressologs.

load("Data/DATA/ones_and_zeros_all.RData")
df_with_sums <- ones_and_zeros_all %>%
  mutate(Angiosperms = rowSums(. [1:3])) %>%
  mutate(Cross = rowSums(. [4:12]))%>%
  mutate(Gymnosperms = rowSums(. [13:15])) %>%
  mutate(Conserved = rowSums(. [1:15]))%>%
  filter(Conserved > 0)


# 3) Refilter the conserved orthogroups to adjust for the initial p-value filtering and vectorise.
conserved_ogs <- df_with_sums%>% 
  filter(rownames(df_with_sums) %in% expressologs$OrthologGroup)


cons_ogs <- rownames(conserved_ogs)
cat("Number of ortholog groups that have at least one (co-)expressolog after initial filtering: ", nrow(conserved_ogs))

```



```{r}


numb_of_cliques_per_og <- c()

for (g in cons_ogs) {
  # print(g)
  
  # g <- "OG0000001"
  
  expressologs_g <- expressologs %>% 
    filter(OrthologGroup == g) 
  
  expressologs_g <- expressologs_g %>% 
    mutate(UGeneSpecies1 = paste0(expressologs_g$Species1, "-", expressologs_g$GeneSpecies1),
           UGeneSpecies2 = paste0(expressologs_g$Species2, "-", expressologs_g$GeneSpecies2))
  
  nodes <- data.frame(name = unique(c(expressologs_g$UGeneSpecies1, expressologs_g$UGeneSpecies2)))
  
  edges <- data.frame(from = expressologs_g$UGeneSpecies1, 
                      to = expressologs_g$UGeneSpecies2)
  
  
  net <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
  
  # largest_clique <- largest_weighted_cliques(net)
  largest_clique <- max_cliques(net, min = 6)
  
  
  
  numb_of_cliques_per_og <- rbind(numb_of_cliques_per_og, data.frame(Orthogroup = g,
                                                                     numbCliques = length(largest_clique)))
  
}



```


```{r}
# Load instead of running the previous chunk and this one.....
numb_of_cliques_per_og <- numb_of_cliques_per_og %>% 
  arrange(desc(numbCliques)) %>% 
  mutate(index = 1:nrow(numb_of_cliques_per_og)) %>% 
  filter(numbCliques > 0) 

paste0("Number of orthologs with at least one 6-membered clique: ", length(unique(numb_of_cliques_per_og$Orthogroup)))
cons_og_red <- numb_of_cliques_per_og$Orthogroup

save(cons_og_red, file = "Data/Data/conserved_orthogroups_reduced.RData")
  
# head(numb_of_cliques_per_og)
# 
# plot(density(log10(numb_of_cliques_per_og$numbCliques)),xlab = "Number of cliques per OG (log10)",main = "Distribution of cliques")

```



```{r}

# Go through the list of ortholog groups that have at least one clique containing all 6 species and identify all cliques within the various orthogroups.

load("Data/DATA/conserved_orthogroups_reduced.RData")
expressologs_from_max_cliques <- list()

for (g in cons_og_red) {
  print(g)
  
   # g <- "OG0000059"
  
  expressologs_g <- expressologs %>% 
    filter(OrthologGroup == g) 
  
  expressologs_g <- expressologs_g %>% 
    mutate(UGeneSpecies1 = paste0(expressologs_g$Species1, "-", expressologs_g$GeneSpecies1),
           UGeneSpecies2 = paste0(expressologs_g$Species2, "-", expressologs_g$GeneSpecies2))
  
  nodes <- data.frame(name = unique(c(expressologs_g$UGeneSpecies1, expressologs_g$UGeneSpecies2)))
  
  edges <- data.frame(from = expressologs_g$UGeneSpecies1, 
                      to = expressologs_g$UGeneSpecies2)
   
  
  net <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
  
  # largest_clique <- largest_weighted_cliques(net)
  largest_clique <- max_cliques(net, min = 6)

  if(length(largest_clique) > 5500){
      largest_clique_red <- largest_clique[1:5500]
    }else{largest_clique_red <- largest_clique}
    
    
  for(c in 1:length(largest_clique_red)){
    # c <- 1
          if (c %% 500 == 0) {
        cat(c, "\n")
      }


    clique <- largest_clique[[c]]
    clique_name <- attr(clique, "names")

    clique_species <- str_split_fixed(clique_name, "-", n = 2)[,1]
    clique_genes <-  str_split_fixed(clique_name, "-", n = 2)[,2]
   


      expressologs_in_clique <- expressologs_g %>%
        filter(UGeneSpecies1 %in% clique_name & UGeneSpecies2 %in% clique_name) %>%
        select(c(1:5, 8)) %>% 
        mutate(cliqueNum = paste0(g,"_" ,c))
        
        

      expressologs_from_max_cliques <- append(expressologs_from_max_cliques, list(expressologs_in_clique))

  }

}



```


```{r}

clique_genes_unlisted <- plyr::ldply(expressologs_from_max_cliques)

clique_genes_unlisted_prefilter <- clique_genes_unlisted %>% 
  group_by(cliqueNum) %>% 
  mutate(MaxpVal = -log(MaxpVal)) %>% 
  mutate(NegLogCliqueSum = sum(MaxpVal)) %>% 
  ungroup()

length(unique(clique_genes_unlisted_prefilter$OrthologGroup))
length(unique(clique_genes_unlisted_prefilter$cliqueNum))
  
save(clique_genes_unlisted_prefilter, file = "Data/DATA/clique_genes_prefiltered.RData")



```



# Creating data frame for group-wise counting


```{r}


load("Data/DATA/clique_genes_all_genes.RData")

# Set p-value threshold or average sum of cliques
p_thr <- 0.1
average_cliqueSum <-  34.53878 # If all (co-)expressologs have a MaxPval of max 0.1, then the minimum sum of a clique is: (-log(0.1))*15 = 34.53878. When filtering for cliques with only co-expressologs: use NegLogCliqueSum >= 34.53878. ???


weighted_max_cliques <- clique_genes_unlisted %>% 
  mutate(species_pair = paste0(Species1, Species2))


speciesPairs <- tibble(SpeciesPair = weighted_max_cliques %>% distinct(species_pair) %>% pull(species_pair),
                       SpeciesPairClade = c("Cross", "Gymno", "Gymno", "Cross", "Cross", "Cross", "Cross", "Angio",
                       "Angio", "Gymno", "Cross", "Cross", "Cross", "Cross", "Angio"))


weighted_max_cliques <-  left_join(weighted_max_cliques , speciesPairs, by = join_by("species_pair" == "SpeciesPair" ))


weighted_max_cliques_filtered <- weighted_max_cliques %>%
  filter(MaxpVal < p_thr) %>% 
  group_by(cliqueNum) %>% 
  mutate(cliqueSize = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = SpeciesPairClade, values_from = SpeciesPairClade)



cat("Number of orthogroups with at least 1 fully sized clique after filtering for clique sum: ", length(unique(weighted_max_cliques_filtered$OrthologGroup)))
cat("Number of 6-membered cliques: ", length(unique(weighted_max_cliques_filtered$cliqueNum)))
  
weighted_max_cliques_filtered$Angio[is.na(weighted_max_cliques_filtered$Angio)] <- 0
weighted_max_cliques_filtered$Angio[weighted_max_cliques_filtered$Angio != 0] <-1
weighted_max_cliques_filtered$Gymno[is.na(weighted_max_cliques_filtered$Gymno)] <-0
weighted_max_cliques_filtered$Gymno[weighted_max_cliques_filtered$Gymno != 0] <-1
weighted_max_cliques_filtered$Cross[is.na(weighted_max_cliques_filtered$Cross)] <-0
weighted_max_cliques_filtered$Cross[weighted_max_cliques_filtered$Cross != 0] <-1



```




## Plotting the number of ultra-conserved and partially conserved ortholog groups



```{r}


ultra_conserved <- weighted_max_cliques_filtered %>% 
  filter(cliqueSize == 15) 

length(unique(ultra_conserved$OrthologGroup))


# Saving the uuc-genes
uuc_genes_filtered <- uuc_genes %>% 
  filter(Orthogroup %in% ultra_conserved$OrthologGroup) %>% 
  group_by(Species) %>% 
  distinct(Genes, .keep_all = T) %>% 
  ungroup() %>% 
  group_by(Orthogroup) %>% 
  mutate(sum = n()) %>% 
  filter(sum == 6)

length(unique(uuc_genes_filtered$Orthogroup))

# save(uuc_genes_filtered, file = "Data/DATA/uuc_orthologs.RData")

# 
# partial3_conserved <- weighted_clique_group_sum %>% 
#   mutate_at(c("Angio", "Gymno", "Cross"), as.numeric) %>% 
#   group_by(OrthologGroup) %>% 
#   filter(sum(Angio) >=2 & sum(Gymno) >=2 & sum(Cross) >= 2)
# 
# length(unique(partial3_conserved$OrthologGroup))

```





```{r}
#Saving uuc-genes for only Aspen

uuc_genes_asp <- uuc_genes_filtered %>% 
  filter(grepl("Potra", Genes))

save(uuc_genes_asp, file ="Data/DATA/uuc_orthologs_asp.RData") # Now go to GSEA!

```



